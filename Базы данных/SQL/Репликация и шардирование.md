
**Репликация и шардирование** — это два подхода к масштабированию PostgreSQL. Они решают разные задачи:  
- **Репликация** обеспечивает отказоустойчивость и распределение нагрузки на чтение.  
- **Шардирование** позволяет горизонтально масштабировать запись и хранение данных.  

Разберем оба подхода, их типы и инструменты.

---

## **1. Репликация в PostgreSQL**
### **Цели**
- **Высокая доступность:** При падении мастера реплика берет на себя его роль.  
- **Распределение нагрузки:** Реплики обрабатывают запросы на чтение.  
- **Геораспределение:** Данные ближе к пользователям (например, реплики в разных регионах).

---

### **Типы репликации**
#### **a. Физическая репликация (Streaming Replication)**  
- **Как работает:** Копирует бинарные WAL-журналы (Write-Ahead Log) с мастера на реплику.  
- **Особенности:**  
  - Реплика — точная копия мастера (все данные и схемы).  
  - Поддерживает синхронный и асинхронный режимы.  
  - **Синхронный режим:** Гарантирует, что транзакция подтверждается только после записи на мастер и реплику.  

**Настройка:**  
1. В `postgresql.conf` мастера:  
   ```ini
   wal_level = replica
   max_wal_senders = 10
   hot_standby = on
   ```
2. В `pg_hba.conf` мастера:  
   ```ini
   host replication replica_user 192.168.1.100/32 md5
   ```
3. На реплике:  
   ```bash
   pg_basebackup -h master_host -U replica_user -D /var/lib/postgresql/data -P
   ```

---

#### **b. Логическая репликация**  
- **Как работает:** Копирует изменения данных на уровне SQL (отдельные таблицы или строки).  
- **Особенности:**  
  - Можно реплицировать только часть данных.  
  - Мастер и реплика могут иметь разные схемы.  

**Настройка:**  
1. На мастере:  
   ```sql
   CREATE PUBLICATION my_pub FOR TABLE users, orders;
   ```
2. На реплике:  
   ```sql
   CREATE SUBSCRIPTION my_sub 
   CONNECTION 'host=master_host user=replica_user' 
   PUBLICATION my_pub;
   ```

---

### **Инструменты**
- **PgBouncer/PgPool-II:** Для балансировки запросов между репликами.  
- **Patroni:** Управление кластером с автоматическим failover.  

---

## **2. Шардирование в PostgreSQL**
### **Цели**
- **Горизонтальное масштабирование:** Распределение данных между серверами (шардами).  
- **Увеличение пропускной способности:** Параллельная обработка запросов.  
- **Снижение нагрузки на диск:** Каждый шард хранит часть данных.  

---

### **Типы шардирования**
#### **a. Ручное шардирование**  
- **Как работает:** Данные разделяются по правилу (например, по диапазону ID или хэшу).  
- **Пример:**  
  - Шард 1: `user_id` от 1 до 1000.  
  - Шард 2: `user_id` от 1001 до 2000.  

**Недостатки:**  
- Сложность управления (требуется ручная маршрутизация запросов).  
- Нет встроенной поддержки распределенных транзакций.  

---

#### **b. Шардирование через расширения**  
**Citus** — популярное расширение для автоматического шардирования:  
- **Как работает:** Превращает PostgreSQL в распределенную СУБД.  
- **Функции:**  
  - Автоматическое распределение данных.  
  - Поддержка SQL-запросов с агрегацией по шардам.  
  - Параллельное выполнение операций.  

**Настройка:**  
1. Установите Citus на всех узлах.  
2. На координаторе (главном узле):  
   ```sql
   CREATE EXTENSION citus;
   SELECT master_add_node('shard1_host', 5432);
   SELECT master_add_node('shard2_host', 5432);
   ```
3. Создайте распределенную таблицу:  
   ```sql
   CREATE TABLE users (user_id int, name text);
   SELECT create_distributed_table('users', 'user_id');
   ```

---

### **Сравнение репликации и шардирования**
| Критерий           | Репликация           | Шардирование                   |  
|--------------------|----------------------|--------------------------------|  
| Масштабирование    | Только чтение        | Чтение и запись                |  
| Сложность          | Проще в настройке    | Требует управления шардами     |  
| Отказоустойчивость | Высокая (failover)   | Зависит от реализации          |  
| Использование      | HA, геораспределение | Большие объемы данных/нагрузка |

## **3. Советы и предостережения**
### **Для репликации**
- Используйте **синхронную репликацию** для критически важных данных.  
- Мониторьте **лаг реплики** (через `pg_stat_replication`).  
- Настройте **автоматический failover** (например, через Patroni).  

### **Для шардирования**
- Выбирайте **правильный ключ шардирования** (равномерное распределение).  
- Избегайте распределенных транзакций — они замедляют работу.  
- Используйте **Citus** или **Vitess** для автоматизации.  

---

## **4. Пример архитектуры**
**Комбинированный подход (Репликация + Шардирование):**  
- Каждый шард — это отдельный кластер PostgreSQL с мастером и репликами.  
- Запросы распределяются между шардами через координатор (Citus).  
- Реплики шардов обслуживают запросы на чтение.  

---

**Итог:**  
- **Репликация** подходит для повышения доступности и распределения нагрузки на чтение.  
- **Шардирование** необходимо при работе с Big Data или высокой нагрузкой на запись.  
- Используйте их вместе для максимальной масштабируемости и отказоустойчивости.